name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      BACKEND_API_URL:
        description: '后端API地址'
        required: true
        type: string
      AES_KEY:
        description: 'AES加密密钥(16位16进制)'
        required: true
        type: string
      PORT:
        description: '服务器监听端口'
        required: false
        default: '3000'
        type: string
      PATH_PREFIX:
        description: '路径前缀'
        required: false
        default: '/ez/ez'
        type: string
      CORS_ORIGIN:
        description: 'CORS源'
        required: false
        default: '*'
        type: string
      ALLOWED_ORIGINS:
        description: '允许的来源'
        required: false
        default: '*'
        type: string
      REQUEST_TIMEOUT:
        description: '请求超时(ms)'
        required: false
        default: '30000'
        type: string
      ALLOWED_PAYMENT_NOTIFY_PATHS:
        description: '支付回调免验证路径'
        required: false
        default: ''
        type: string
      ENABLE_LOGGING:
        description: '是否启用日志'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'

jobs:
  build:
    runs-on: ubuntu-latest
    
    env:
      # 设置默认环境变量，可以通过workflow_dispatch输入或secrets覆盖
      PORT: ${{ github.event.inputs.PORT || '3000' }}
      BACKEND_API_URL: ${{ github.event.inputs.BACKEND_API_URL || secrets.BACKEND_API_URL || 'https://skhsn6q4pnv95.ezdemo.xyz' }}
      PATH_PREFIX: ${{ github.event.inputs.PATH_PREFIX || secrets.PATH_PREFIX || '/ez/ez' }}
      CORS_ORIGIN: ${{ github.event.inputs.CORS_ORIGIN || secrets.CORS_ORIGIN || '*' }}
      ALLOWED_ORIGINS: ${{ github.event.inputs.ALLOWED_ORIGINS || secrets.ALLOWED_ORIGINS || '*' }}
      REQUEST_TIMEOUT: ${{ github.event.inputs.REQUEST_TIMEOUT || secrets.REQUEST_TIMEOUT || '30000' }}
      ALLOWED_PAYMENT_NOTIFY_PATHS: ${{ github.event.inputs.ALLOWED_PAYMENT_NOTIFY_PATHS || secrets.ALLOWED_PAYMENT_NOTIFY_PATHS || '' }}
      ENABLE_LOGGING: ${{ github.event.inputs.ENABLE_LOGGING || secrets.ENABLE_LOGGING || 'false' }}
      DEBUG_MODE: ${{ secrets.DEBUG_MODE || 'false' }}
      AES_KEY: ${{ github.event.inputs.AES_KEY || secrets.AES_KEY || '4c6f8e5f9467dc71' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'
        
    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-
          
    - name: Download dependencies
      run: go mod download
      
    - name: Verify dependencies
      run: go mod verify
      
    - name: Generate .env file
      run: |
        cat > .env << EOF
        # 1. 基础服务器设置
        PORT=$PORT
        BACKEND_API_URL=$BACKEND_API_URL
        PATH_PREFIX=$PATH_PREFIX
        
        # 2. CORS / 安全设置
        CORS_ORIGIN=$CORS_ORIGIN
        ALLOWED_ORIGINS=$ALLOWED_ORIGINS
        REQUEST_TIMEOUT=$REQUEST_TIMEOUT
        ENABLE_LOGGING=$ENABLE_LOGGING
        DEBUG_MODE=$DEBUG_MODE
        
        # 3. 支付回调免验证路径
        ALLOWED_PAYMENT_NOTIFY_PATHS=$ALLOWED_PAYMENT_NOTIFY_PATHS
        
        # 5. AES 加解密配置
        AES_KEY=$AES_KEY
        EOF
        
        echo "Generated .env file:"
        cat .env
        
    - name: Build for Linux ARM64
      run: |
        GOOS=linux GOARCH=arm64 CGO_ENABLED=0 go build -ldflags="-s -w" -o proxy-server-arm64 .
        
    - name: Build for Linux AMD64
      run: |
        GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -ldflags="-s -w" -o proxy-server-amd64 .
        
    - name: Create release archive
      run: |
        # 清理环境
        rm -rf release
        mkdir -p release
        
        # 显示当前目录内容
        echo "Current directory contents:"
        ls -la
        
        # 创建Linux ARM64和AMD64的压缩包
        echo "Creating archives for Linux ARM64 and AMD64..."
        
        # Linux ARM64
        if [ -f "proxy-server-arm64" ]; then
          echo "Creating Linux ARM64 archive..."
          mkdir -p temp-linux-arm64
          cp proxy-server-arm64 temp-linux-arm64/
          cp README.md temp-linux-arm64/
          cp .env temp-linux-arm64/
          tar -czf EZ-Encrypt-Middleware-linux-arm64.tar.gz -C temp-linux-arm64 .
          rm -rf temp-linux-arm64
          echo "Created: EZ-Encrypt-Middleware-linux-arm64.tar.gz"
        fi
        
        # Linux AMD64
        if [ -f "proxy-server-amd64" ]; then
          echo "Creating Linux AMD64 archive..."
          mkdir -p temp-linux-amd64
          cp proxy-server-amd64 temp-linux-amd64/
          cp README.md temp-linux-amd64/
          cp .env temp-linux-amd64/
          tar -czf EZ-Encrypt-Middleware-linux-amd64.tar.gz -C temp-linux-amd64 .
          rm -rf temp-linux-amd64
          echo "Created: EZ-Encrypt-Middleware-linux-amd64.tar.gz"
        fi
        
        # 移动所有压缩包到release目录
        mv EZ-Encrypt-Middleware-*.tar.gz EZ-Encrypt-Middleware-*.zip release/ 2>/dev/null || true
        
        # 显示最终结果
        echo "Final archives in release directory:"
        ls -la release/
        
    - name: Upload release artifacts
      uses: actions/upload-artifact@v4
      with:
        name: release-binaries
        path: release/
        
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release/EZ-Encrypt-Middleware-linux-arm64.tar.gz
          release/EZ-Encrypt-Middleware-linux-amd64.tar.gz
          release/EZ-Encrypt-Middleware-windows-amd64.zip
          release/EZ-Encrypt-Middleware-darwin-amd64.tar.gz
          release/EZ-Encrypt-Middleware-darwin-arm64.tar.gz
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
